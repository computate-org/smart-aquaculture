apiVersion: v1
kind: ConfigMap
metadata:
  name: solr-setup-tasks
  namespace: smartaquaculture
data:
  main.yaml: |
    ---
    - name: >-
        Create smartaquaculture collection: 
        SOLR_AUTH_TYPE=basic 
        SOLR_AUTHENTICATION_OPTS="-Dbasicauth=admin:$(cat /opt/bitnami/solr/secrets/pass/password)" 
        /opt/bitnami/solr/bin/solr create_collection --solr-url http://localhost:8983 -c smartaquaculture -n computate'
      kubernetes.core.k8s_exec:
        namespace: solr
        pod: solr-0
        command: >-
          bash -c '
          SOLR_AUTH_TYPE=basic
          SOLR_AUTHENTICATION_OPTS="-Dbasicauth=admin:$(cat /opt/bitnami/solr/secrets/pass/password)" 
          /opt/bitnami/solr/bin/solr create_collection --solr-url http://localhost:8983 -c smartaquaculture -n computate
          '
      register: create_smartaquaculture_collection
      ignore_errors: true
    - name: Debug create_smartaquaculture_collection
      debug:
        var: create_smartaquaculture_collection
    - name: Test create smartaquaculture collection success
      fail:
        msg: "{{ command_status }}"
      when: create_smartaquaculture_collection.failed and create_smartaquaculture_collection is not search("already exists")
